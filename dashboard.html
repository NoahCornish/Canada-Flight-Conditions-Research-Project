<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CFCRP • Canada Flight Conditions Research Project</title>

  <!-- Fonts & libs -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f4f6f9; --card:#ffffff; --ink:#233545; --muted:#607288; --brand:#1a73e8; --brand2:#2ecc71;
      --shadow:0 8px 24px rgba(0,0,0,.08);
      --vfr:#2ecc71; --mvfr:#3498db; --ifr:#e74c3c; --lifr:#8e44ad;
      --chip:#eef2f7;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}

    header{position:sticky;top:0;z-index:50;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;box-shadow:var(--shadow)}
    .wrap{max-width:1200px;margin:0 auto;padding:1.25rem 1rem;display:flex;gap:1rem;align-items:center;justify-content:space-between}
    .branding{display:flex;gap:.9rem;align-items:center}
    .logo{width:42px;height:42px;border-radius:12px;background:#fff1;border:1px solid #ffffff44;display:grid;place-items:center;font-weight:800}
    .title{line-height:1}
    .title h1{margin:0;font-size:1.25rem;font-weight:800}
    .title p{margin:.25rem 0 0;opacity:.92;font-weight:600;font-size:.9rem}

    nav{display:flex;gap:.5rem}
    .tab{appearance:none;border:none;background:#fff;color:var(--brand);font-weight:700;padding:.55rem .9rem;border-radius:10px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.12);transition:.18s}
    .tab[aria-selected="true"]{background:#0b2540;color:#fff}

    main{max-width:1200px;margin:1.25rem auto;padding:0 1rem 2rem;display:grid;gap:1rem}

    .about{display:grid;grid-template-columns:1.2fr .8fr;gap:1rem}
    .card{background:var(--card);border-radius:18px;padding:1.1rem 1.2rem;box-shadow:var(--shadow)}
    .about h2{margin:.2rem 0 .6rem}
    .chips{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.4rem}
    .chip{background:var(--chip);color:var(--muted);font-weight:700;border-radius:999px;padding:.3rem .6rem;font-size:.8rem}
    .legend{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.4rem}
    .swatch{display:inline-flex;align-items:center;gap:.4rem;padding:.25rem .55rem;border-radius:999px;background:#f6f8fb;color:#333;font-weight:700;font-size:.8rem}
    .box{width:.9rem;height:.9rem;border-radius:3px}

    .views{display:grid;gap:1rem}
    .controls{display:flex;flex-wrap:wrap;gap:.6rem;align-items:center}
    .controls select{padding:.65rem .8rem;border:1px solid #d5dbe3;border-radius:12px;background:#fff;font:inherit;min-width:260px}
    .note{color:var(--muted);font-size:.9rem}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem}
    .airport{padding:1rem}
    .icao{font-weight:800;font-size:1rem;opacity:.8}
    .name{color:#0b2540;font-weight:800;font-size:1.15rem}
    .meta{display:flex;gap:.6rem;flex-wrap:wrap;margin:.5rem 0}
    .badge{padding:.15rem .5rem;border-radius:999px;color:#fff;font-weight:800;font-size:.78rem;letter-spacing:.4px}
    .cat-VFR{background:var(--vfr)} .cat-MVFR{background:var(--mvfr)} .cat-IFR{background:var(--ifr)} .cat-LIFR{background:var(--lifr)}
    .pill{background:#eef7ff;color:#0b2540;border:1px solid #cfe2ff}
    .kv{display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-top:.4rem}
    .kv .k{color:var(--muted);font-weight:700}
    .last{font-weight:700;color:#0b2540;margin:.25rem 0 .75rem}
    .chart-wrap{background:#fbfdff;border:1px dashed #cfe2ff;border-radius:14px;padding:10px}
    footer{padding:2rem 1rem;color:var(--muted);text-align:center}

    @media (max-width:900px){ .about{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="branding">
        <div class="logo">✈️</div>
        <div class="title">
          <h1>CFCRP — Canada Flight Conditions Research Project</h1>
          <p>Hourly METAR ingestion • Standardized VFR/MVFR/IFR/LIFR visuals • Regional trend analysis</p>
        </div>
      </div>
      <nav>
        <button class="tab" id="tab-airport" aria-selected="true">Airport Explorer</button>
        <button class="tab" id="tab-region" aria-selected="false">National Overview</button>
      </nav>
    </div>
  </header>

  <main>
    <!-- ABOUT -->
    <section class="about">
      <article class="card">
        <h2>About the Project</h2>
        <p>
          The <strong>Canada Flight Conditions Research Project (CFCRP)</strong> collects and analyzes hourly METAR data from airports across Canada.
          We standardize flight categories (<strong>VFR</strong>, <strong>MVFR</strong>, <strong>IFR</strong>, <strong>LIFR</strong>) and visualize conditions to reveal
          <em>regional</em> and <em>seasonal</em> patterns that matter to pilots, dispatchers, and researchers.
        </p>
        <p>
          Why it matters: aviation weather drives operational safety and planning. A clean, Canada-wide view helps identify hotspots, understand diurnal/seasonal shifts, and track trends over time.
        </p>
        <div class="legend" aria-label="CFCRP Legend">
          <span class="swatch"><span class="box" style="background:var(--vfr)"></span>VFR</span>
          <span class="swatch"><span class="box" style="background:var(--mvfr)"></span>MVFR</span>
          <span class="swatch"><span class="box" style="background:var(--ifr)"></span>IFR</span>
          <span class="swatch"><span class="box" style="background:var(--lifr)"></span>LIFR</span>
        </div>
        <div class="chips">
          <span class="chip">Automated hourly pipeline</span>
          <span class="chip">Clean CSV outputs</span>
          <span class="chip">Charts & dashboards</span>
          <span class="chip">Open methods</span>
        </div>
        <div id="diagBox" class="note" style="margin-top:.6rem"></div>
      </article>
      <aside class="card">
        <h2>Status & Data</h2>
        <p class="note">Latest dataset timestamp: <span id="lastUpdated">—</span></p>
        <!-- Counts chips coloured by scheme -->
        <div id="countsRow" class="chips" style="margin:.25rem 0 .5rem">
          <span id="countVFR" class="chip" style="background:var(--vfr);color:#fff">VFR: 0</span>
          <span id="countMVFR" class="chip" style="background:var(--mvfr);color:#fff">MVFR: 0</span>
          <span id="countIFR" class="chip" style="background:var(--ifr);color:#fff">IFR: 0</span>
          <span id="countLIFR" class="chip" style="background:var(--lifr);color:#fff">LIFR: 0</span>
        </div>
        <div class="chart-wrap" style="margin-top:.25rem">
          <canvas id="nationalBreakdown" height="110"></canvas>
        </div>
        <p class="note" style="margin-top:.5rem">National breakdown: latest reports by category (counts above, chart below).</p>
        <div class="controls" style="margin-top:.75rem">
          <label for="airportSelect" class="note">Jump to airport:</label>
          <select id="airportSelect"><option disabled selected>Loading…</option></select>
          <button class="tab" id="viewAirport">Open in Explorer</button>
        </div>
      </aside>
    </section>

    <!-- VIEWS -->
    <section class="views">
      <!-- Airport Explorer -->
      <div id="view-airport" class="card" role="region" aria-labelledby="tab-airport">
        <h2>Airport Explorer</h2>
        <div id="airportDetail" class="grid"></div>
      </div>

      <!-- National Overview -->
      <div id="view-region" class="card" role="region" aria-labelledby="tab-region" style="display:none">
        <h2>National Overview</h2>
        <p class="note" style="margin:.25rem 0 1rem">Latest observed conditions for <strong>all detected airports</strong> in the dataset.</p>
        <div id="regionGrid" class="grid"></div>
      </div>
    </section>

    <!-- Bottom selector -->
    <section class="views">
      <div class="card">
        <h2>Quick Airport Selector</h2>
        <div class="controls" style="margin:.5rem 0 0">
          <select id="airportSelectBottom"><option disabled selected>Loading…</option></select>
          <button class="tab" id="openBottom">Open in Explorer</button>
        </div>
      </div>
    </section>
  </main>

  <footer>
    CFCRP © <span id="year"></span> · Built with open data (METAR) · Colours: VFR (green), MVFR (blue), IFR (red), LIFR (purple)
  </footer>

  <script>
    // ---------- Utilities ----------
    function $(sel){ return document.querySelector(sel); }
    function toLocalTime(utc){
      if(!utc) return '';
      var str = utc; if (str.charAt(str.length-1) !== 'Z') str += 'Z';
      var d = new Date(str);
      try { return d.toLocaleString('en-CA',{timeZone:'America/Toronto',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}); }
      catch(e){ return d.toLocaleString(); }
    }
    function logDiag(msg){ console.log('[CFCRP]', msg); var box=$('#diagBox'); if(box){ var p=document.createElement('div'); p.textContent=msg; box.appendChild(p);} }

    // Friendly names map (augmented from CSV if available)
    var stations = {}; // ICAO -> name

    var latestByAirport = {}; // ICAO -> latest row
    var globalLatest = null;

    // Header alias map
    var FIELD = {
      icao:       ['icao','station','station_id'],
      observed:   ['observed_utc','obs_time','observation_time','time','obs_time_utc'],
      category:   ['flight_category','category','cond','flight_cat'],
      wind_kts:   ['wind_kts','wind_speed_kt','wind_kt'],
      wind_dir:   ['wind_dir_deg','wind_direction_deg','wind_deg'],
      temp_c:     ['temp_c','temperature_c','temp_celsius'],
      dew_c:      ['dewpoint_c','dewpoint_celsius','dew_c'],
      rh:         ['rh_percent','relative_humidity','humidity'],
      alt_hg:     ['altimeter_hg','altim_in_hg','altimeter_in_hg'],
      raw:        ['raw_text','metar','raw'],
      name:       ['airport_name','name','station_name']
    };
    function pick(row, keys){ for(var i=0;i<keys.length;i++){ var k=keys[i]; if(row.hasOwnProperty(k) && row[k]!==undefined && row[k]!==null && row[k]!=='') return row[k]; } }
    function toNum(v){ if(v===undefined||v===null||v==='') return undefined; var n=+v; return isNaN(n)?undefined:n; }
    function normalizeRow(row){
      var icao = pick(row, FIELD.icao); icao = icao? String(icao).trim().toUpperCase():'';
      var observed = pick(row, FIELD.observed) || '';
      var cat = pick(row, FIELD.category); cat = cat? String(cat).toUpperCase():'';
      var obj = {
        icao: icao,
        observed_utc: observed,
        flight_category: cat,
        wind_kts: toNum(pick(row, FIELD.wind_kts)),
        wind_dir_deg: toNum(pick(row, FIELD.wind_dir)),
        temp_c: toNum(pick(row, FIELD.temp_c)),
        dewpoint_c: toNum(pick(row, FIELD.dew_c)),
        rh_percent: toNum(pick(row, FIELD.rh)),
        altimeter_hg: toNum(pick(row, FIELD.alt_hg)),
        raw_text: pick(row, FIELD.raw) || ''
      };
      var friendly = pick(row, FIELD.name);
      if(icao && friendly && !stations[icao]) stations[icao] = friendly;
      return obj;
    }

    // -------- Data Load (clean_metars.csv or ?csv=...) --------
    var urlParams = new URLSearchParams(location.search);
    var CSV_PATH = urlParams.get('csv') || './clean_metars.csv';
    $('#year').textContent = new Date().getFullYear();

    if (location.protocol === 'file:') logDiag('⚠️ Opened via file:// — browsers may block CSV loading. Use a local server or GitHub Pages.');
    logDiag('CSV path resolved to: ' + CSV_PATH);

    fetch(CSV_PATH, { method: 'HEAD', cache: 'no-store' })
      .then(function(resp){ logDiag('HEAD ' + CSV_PATH + ' → ' + resp.status); if(!resp.ok) throw new Error('CSV not found'); startPapaDownload(CSV_PATH); })
      .catch(function(){ logDiag('HEAD failed; attempting GET fallback…'); fetch(CSV_PATH, { cache: 'no-store' })
        .then(function(r){ if(!r.ok) throw new Error('GET failed ('+r.status+')'); return r.text(); })
        .then(function(txt){ logDiag('Fetched CSV via GET fallback. Parsing…'); startPapaFromText(txt); })
        .catch(function(e2){ logDiag('❌ CSV fetch failed: ' + e2.message); $('#lastUpdated').textContent='Failed to load data (check path/CORS).'; });
      });

    function startPapaDownload(path){
      logDiag('Starting Papa.parse download…');
      Papa.parse(path, {
        download: true,
        header: true,
        error: function(err){ console.error('CSV load error:', err); logDiag('Papa download error: ' + err); $('#lastUpdated').textContent='Failed to load data.'; },
        complete: function(res){ processCsv(res.data || [], res.data); }
      });
    }
    function startPapaFromText(text){ Papa.parse(text, { header:true, complete: function(res){ processCsv(res.data || [], res.data); } }); }

    function processCsv(raw, rawAll){
      var rows = [];
      for (var i=0;i<raw.length;i++){ var norm=normalizeRow(raw[i]); if(norm.icao && norm.observed_utc) rows.push(norm); }
      for (var j=0;j<rows.length;j++){
        var r = rows[j]; var obs = r.observed_utc || ''; var iso = obs.charAt(obs.length-1)==='Z' ? obs : obs + 'Z'; var t=new Date(iso);
        var prev = latestByAirport[r.icao]; if(!prev || t > new Date(prev.observed_utc)){ r.observed_utc = iso; latestByAirport[r.icao] = r; }
        if(!globalLatest || t > new Date(globalLatest)) globalLatest = iso;
      }
      logDiag('Parsed rows: ' + (rawAll && rawAll.length ? rawAll.length : raw.length));
      logDiag('Usable rows: ' + rows.length);
      logDiag('Airports detected: ' + Object.keys(latestByAirport).length);
      initUI();
      renderNational();
    }

    // ---------- UI ----------
    function initUI(){
      $('#lastUpdated').textContent = globalLatest ? toLocalTime(globalLatest) : '—';
      if(!globalLatest) logDiag('No data found. Ensure the CSV exists at ' + CSV_PATH + ' or pass ?csv=relative/path.csv');

      var icaos = Object.keys(latestByAirport).sort();
      var selTop = $('#airportSelect'), selBottom = $('#airportSelectBottom');
      selTop.innerHTML=''; selBottom.innerHTML='';
      for (var i=0;i<icaos.length;i++){
        var icao = icaos[i]; var label = stations[icao] ? (icao + ' — ' + stations[icao]) : icao;
        var o1=document.createElement('option'); o1.value=icao; o1.textContent=label; selTop.appendChild(o1);
        var oB=document.createElement('option'); oB.value=icao; oB.textContent=label; selBottom.appendChild(oB);
      }
      $('#viewAirport').addEventListener('click', function(){ var v=$('#airportSelect').value; if(v){ $('#tab-airport').click(); showAirport(v);} });
      $('#openBottom').addEventListener('click', function(){ var v=$('#airportSelectBottom').value; if(v){ $('#tab-airport').click(); showAirport(v);} });

      // Tabs
      $('#tab-airport').addEventListener('click', function(){ setView('airport'); });
      $('#tab-region').addEventListener('click', function(){ setView('region'); showRegionAll(); });

      // Defaults
      if (icaos.indexOf('CYMO') >= 0) showAirport('CYMO'); else if(icaos.length) showAirport(icaos[0]);
      showRegionAll();

      $('#year').textContent = new Date().getFullYear();
    }

    function setView(which){
      var isAirport = which==='airport';
      $('#view-airport').style.display = isAirport? 'block':'none';
      $('#view-region').style.display = isAirport? 'none':'block';
      $('#tab-airport').setAttribute('aria-selected', isAirport ? 'true' : 'false');
      $('#tab-region').setAttribute('aria-selected', isAirport ? 'false' : 'true');
      window.scrollTo({top:0,behavior:'smooth'});
    }

    // ---------- Airport Explorer ----------
    function showAirport(icao){
      var r = latestByAirport[icao];
      var grid = $('#airportDetail'); grid.innerHTML='';
      if(!r){ grid.innerHTML = '<p class="note">No data available for this station yet.</p>'; return; }
      grid.appendChild(renderAirportCard(icao, r, true));
    }

    function renderAirportCard(icao, r, withChart){
      var card = document.createElement('div'); card.className='airport card';
      var name = stations[icao] || icao;
      card.innerHTML =
        '<div class="name">' + name + '</div>' +
        '<div class="icao">' + icao + '</div>' +
        '<div class="meta">' +
          '<span class="badge cat-' + (r.flight_category || 'VFR') + '">' + (r.flight_category || 'VFR') + '</span>' +
          '<span class="badge pill">' + toLocalTime(r.observed_utc) + '</span>' +
          '<span class="badge pill">Wind ' + (r.wind_dir_deg!=null?r.wind_dir_deg:'—') + '° @ ' + (r.wind_kts!=null?r.wind_kts:'—') + ' kt</span>' +
        '</div>' +
        '<div class="kv">' +
          '<div><div class="k">Temp</div><div>' + (r.temp_c!=null?r.temp_c:'—') + ' °C</div></div>' +
          '<div><div class="k">Dewpoint</div><div>' + (r.dewpoint_c!=null?r.dewpoint_c:'—') + ' °C</div></div>' +
          '<div><div class="k">Humidity</div><div>' + (r.rh_percent!=null?r.rh_percent:'—') + '%</div></div>' +
          '<div><div class="k">Altimeter</div><div>' + (r.altimeter_hg!=null?r.altimeter_hg:'—') + ' inHg</div></div>' +
        '</div>' +
        '<div class="last">Raw METAR</div>' +
        '<div style="font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;background:#f6f8fb;border-left:4px solid var(--brand);padding:.6rem;border-radius:10px">' +
          String(r.raw_text || '').replace(/</g,'&lt;') +
        '</div>';

      if(withChart){
        var wrap = document.createElement('div'); wrap.className='chart-wrap'; wrap.style.marginTop='10px';
        wrap.innerHTML = '<canvas height="120"></canvas>';
        card.appendChild(wrap);
        var ctx = wrap.querySelector('canvas');
        var totals = categoryTotalsFor(icao);
        new Chart(ctx,{
          type:'doughnut',
          data:{ labels:['VFR','MVFR','IFR','LIFR'], datasets:[{ data:[totals.VFR,totals.MVFR,totals.IFR,totals.LIFR], backgroundColor:['var(--vfr)','var(--mvfr)','var(--ifr)','var(--lifr)'] }] },
          options:{ plugins:{ legend:{position:'bottom'} }, cutout:'55%' }
        });
      }
      return card;
    }

    function categoryTotalsFor(icao){
      var t={VFR:0,MVFR:0,IFR:0,LIFR:0};
      var r=latestByAirport[icao]; if(r && r.flight_category && t.hasOwnProperty(r.flight_category)) t[r.flight_category]++;
      var base=0.2; t.VFR+=base; t.MVFR+=base; t.IFR+=base; t.LIFR+=base; return t;
    }

    // ---------- National Overview ----------
    function showRegionAll(){
      var grid=$('#regionGrid'); grid.innerHTML='';
      var list = Object.keys(latestByAirport).sort();
      for (var i=0;i<list.length;i++){
        var icao = list[i]; var r = latestByAirport[icao]; grid.appendChild(renderAirportTile(icao,r));
      }
    }

    function renderAirportTile(icao,r){
      var card=document.createElement('div'); card.className='airport card';
      var name = stations[icao] || icao;
      if(!r){ card.innerHTML='<div class="name">'+name+'</div><div class="icao">'+icao+'</div><p class="note">No data yet</p>'; return card; }
      card.innerHTML =
        '<div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem">' +
          '<div>' +
            '<div class="name" style="font-size:1.05rem;font-weight:800">'+name+'</div>' +
            '<div class="icao" style="opacity:.8">'+icao+'</div>' +
          '</div>' +
          '<span class="badge cat-'+r.flight_category+'">'+r.flight_category+'</span>' +
        '</div>' +
        '<div class="meta">' +
          '<span class="badge pill">'+toLocalTime(r.observed_utc)+'</span>' +
          '<span class="badge pill">'+(r.wind_dir_deg!=null?r.wind_dir_deg:'—')+'° @ '+(r.wind_kts!=null?r.wind_kts:'—')+' kt</span>' +
        '</div>' +
        '<div class="kv">' +
          '<div><div class="k">Temp</div><div>'+(r.temp_c!=null?r.temp_c:'—')+' °C</div></div>' +
          '<div><div class="k">Dewpt</div><div>'+(r.dewpoint_c!=null?r.dewpoint_c:'—')+' °C</div></div>' +
          '<div><div class="k">RH</div><div>'+(r.rh_percent!=null?r.rh_percent:'—')+'%</div></div>' +
          '<div><div class="k">Alt</div><div>'+(r.altimeter_hg!=null?r.altimeter_hg:'—')+' inHg</div></div>' +
        '</div>';
      return card;
    }

    // ---------- National Breakdown ----------
    function renderNational(){
      var counts={VFR:0,MVFR:0,IFR:0,LIFR:0};
      var vals = Object.keys(latestByAirport).map(function(k){return latestByAirport[k];});
      for (var i=0;i<vals.length;i++){ var r = vals[i]; if(r && counts.hasOwnProperty(r.flight_category)) counts[r.flight_category]++; }
      var elV = document.getElementById('countVFR'); if(elV) elV.textContent = 'VFR: ' + counts.VFR;
      var elM = document.getElementById('countMVFR'); if(elM) elM.textContent = 'MVFR: ' + counts.MVFR;
      var elI = document.getElementById('countIFR'); if(elI) elI.textContent = 'IFR: ' + counts.IFR;
      var elL = document.getElementById('countLIFR'); if(elL) elL.textContent = 'LIFR: ' + counts.LIFR;

      var ctx = document.getElementById('nationalBreakdown');
      new Chart(ctx,{
        type:'bar',
        data:{ labels:['VFR','MVFR','IFR','LIFR'], datasets:[{ label:'Latest reports', data:[counts.VFR,counts.MVFR,counts.IFR,counts.LIFR], backgroundColor:['var(--vfr)','var(--mvfr)','var(--ifr)','var(--lifr)'] }] },
        options:{ plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true, ticks:{precision:0} } } }
      });
    }
  </script>
</body>
</html>
