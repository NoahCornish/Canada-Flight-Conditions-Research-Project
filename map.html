<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Canada METAR Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS/JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; }
    #map { width: 100%; height: 100%; }

    /* Legend */
    .legend {
      position: absolute;
      top: 15px;
      right: 15px;
      background: white;
      padding: 10px 14px;
      border-radius: 6px;
      font-size: 0.9rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    .legend h4 { margin: 0 0 6px 0; font-size: 1rem; }
    .legend span { display: flex; align-items: center; margin-bottom: 4px; }
    .dot {
      width: 12px; height: 12px; border-radius: 50%;
      display: inline-block; margin-right: 6px;
    }
    .dot-vfr { background: #2ecc71; }
    .dot-mvfr { background: #3498db; }
    .dot-ifr { background: #e74c3c; }
    .dot-lifr { background: #8e44ad; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="legend">
    <h4>Flight Categories</h4>
    <span><span class="dot dot-vfr"></span> VFR</span>
    <span><span class="dot dot-mvfr"></span> MVFR</span>
    <span><span class="dot dot-ifr"></span> IFR</span>
    <span><span class="dot dot-lifr"></span> LIFR</span>
  </div>

  <script>
    // Airport coordinates (50 total: 15 Ontario + 35 across Canada)
    const airports = {
      // Ontario
      CYER:[56.018,-87.676], CYAT:[52.927,-82.431], CYMO:[51.291,-80.607],
      CYPL:[51.446,-90.214], CYQT:[48.371,-89.324], CYAM:[46.485,-84.509],
      CYTS:[48.569,-81.377], CYSB:[46.625,-80.798], CYYB:[46.363,-79.422],
      CYOW:[45.322,-75.669], CYGK:[44.225,-76.596], CYQG:[42.275,-82.955],
      CYVV:[44.746,-81.107], CYYZ:[43.677,-79.624], CYQA:[44.974,-79.303],
      // British Columbia
      CYVR:[49.196,-123.181], CYYJ:[48.647,-123.426], CYLW:[49.956,-119.378],
      CYXS:[53.889,-122.679], CYXT:[54.468,-128.576], CYQQ:[49.710,-124.886],
      // Alberta
      CYYC:[51.113,-114.020], CYEG:[53.310,-113.579], CYMM:[56.653,-111.222],
      CYQF:[52.182,-113.894],
      // Saskatchewan/Manitoba
      CYXE:[52.170,-106.700], CYQR:[50.433,-104.666], CYWG:[49.910,-97.239],
      CYBR:[49.909,-99.951],
      // Quebec
      CYUL:[45.470,-73.741], CYHU:[45.517,-73.417], CYQB:[46.791,-71.393],
      CYVO:[48.053,-77.782], CYUY:[48.206,-78.835], CYZV:[50.223,-66.266],
      CYBC:[49.132,-68.204], CYRJ:[48.520,-72.266],
      // Atlantic
      CYHZ:[44.881,-63.509], CYYG:[46.290,-63.121], CYQM:[46.113,-64.678],
      CYFC:[45.868,-66.537], CYYT:[47.618,-52.751], CYQY:[46.161,-60.048],
      // Territories/North
      CYXY:[60.710,-135.067], CYZF:[62.463,-114.440], CYFB:[63.756,-68.556],
      CYRT:[62.811,-92.115], CYBK:[64.298,-96.077], CYRB:[74.717,-94.969],
      CYCO:[67.817,-115.143]
    };

    function categoryColor(cat) {
      switch(cat) {
        case "VFR": return "#2ecc71";
        case "MVFR": return "#3498db";
        case "IFR": return "#e74c3c";
        case "LIFR": return "#8e44ad";
        default: return "#7f8c8d";
      }
    }

    // Initialize map
    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    const bounds = L.latLngBounds([]);

    // Load cleaned dataset
    Papa.parse("clean_metars.csv", {
      download: true,
      header: true,
      complete: function(results) {
        const rows = results.data.filter(r => r.icao && r.observed_utc);
        const latestByAirport = {};

        // Pick most recent per airport
        rows.forEach(r => {
          if (!latestByAirport[r.icao] || new Date(r.observed_utc) > new Date(latestByAirport[r.icao].observed_utc)) {
            latestByAirport[r.icao] = r;
          }
        });

        Object.entries(latestByAirport).forEach(([icao, r]) => {
          if (!airports[icao]) return;
          const [lat, lon] = airports[icao];
          const color = categoryColor(r.flight_category);

          const marker = L.circleMarker([lat, lon], {
            radius: 8,
            fillColor: color,
            color: "#333",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.9
          }).addTo(map);

          marker.bindPopup(`
            <strong>${icao}</strong><br>
            Category: <span style="color:${color}; font-weight:bold">${r.flight_category}</span><br>
            Temp: ${r.temp_c}°C<br>
            Dewpoint: ${r.dewpoint_c}°C<br>
            Wind: ${r.wind_dir_deg}° @ ${r.wind_kts} kts<br>
            Altimeter: ${r.altimeter_hg} inHg<br>
            Obs: ${r.observed_utc}
          `);

          bounds.extend([lat, lon]);
        });

        // Zoom to show all airports
        if (bounds.isValid()) {
          map.fitBounds(bounds, { padding: [50, 50] });
        } else {
          map.setView([55, -96], 4); // fallback: center of Canada
        }
      }
    });
  </script>
</body>
</html>
