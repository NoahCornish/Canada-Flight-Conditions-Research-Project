<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Canada METAR Viewer</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background: #f0f3f7;
      color: #2c3e50;
    }

    header {
      background: linear-gradient(135deg, #1a73e8, #2ecc71);
      color: white;
      padding: 1.5rem;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }
    header h1 {
      margin: 0;
      font-size: 2rem;
      font-weight: 800;
    }
    header p {
      margin: 0.4rem 0 0;
      font-size: 1rem;
      opacity: 0.95;
    }
    .map-btn {
      margin-top: 1rem;
      display: inline-block;
      padding: 0.6rem 1.2rem;
      font-weight: 600;
      color: #1a73e8;
      background: #fff;
      border-radius: 6px;
      text-decoration: none;
      transition: 0.2s;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    .map-btn:hover {
      background: #1a73e8;
      color: white;
    }

    main {
      max-width: 1100px;
      margin: auto;
      padding: 2rem 1rem;
    }

    /* Dropdown selector */
    .selector {
      text-align: center;
      margin: 2rem 0;
    }
    select {
      padding: 0.8rem 1rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-family: inherit;
      width: 85%;
      max-width: 500px;
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .last-updated {
      text-align: center;
      font-size: 0.95rem;
      color: #555;
      margin-bottom: 1.5rem;
      font-weight: 500;
    }

    /* Card */
    .card {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 4px 14px rgba(0,0,0,0.08);
      margin-top: 1rem;
      text-align: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }

    .icao {
      font-size: 1.6rem;
      font-weight: 800;
      margin-bottom: 0.3rem;
    }
    .airport-name {
      font-size: 1rem;
      font-weight: 500;
      color: #555;
      margin-bottom: 0.8rem;
    }
    .obs-time {
      font-size: 0.9rem;
      color: #888;
      margin-bottom: 0.8rem;
    }
    .temp {
      font-size: 1.5rem;
      margin-bottom: 0.4rem;
      font-weight: 700;
      color: #1a73e8;
    }
    .dew {
      font-size: 1rem;
      color: #666;
      margin-bottom: 0.3rem;
    }
    .humidity, .altimeter {
      font-size: 0.95rem;
      margin: 0.2rem 0;
      color: #444;
    }

    /* Category badge */
    .category {
      font-size: 0.9rem;
      font-weight: bold;
      padding: 4px 10px;
      border-radius: 12px;
      margin: 0.6rem auto;
      display: inline-block;
      color: white;
      letter-spacing: 0.5px;
    }
    .cat-VFR { background: #2ecc71; }
    .cat-MVFR { background: #3498db; }
    .cat-IFR { background: #e74c3c; }
    .cat-LIFR { background: #8e44ad; }

    /* Wind compass */
    .wind { font-size: 1rem; margin-top: 1rem; }
    .wind-compass {
      position: relative;
      width: 100px;
      height: 100px;
      margin: 0.8rem auto;
      border: 2px solid #bbb;
      border-radius: 50%;
      font-size: 0.75rem;
      color: #555;
      background: #fafafa;
    }
    .wind-compass .label {
      position: absolute;
      font-weight: bold;
    }
    .wind-compass .N { top: 5px; left: 50%; transform: translateX(-50%); }
    .wind-compass .S { bottom: 5px; left: 50%; transform: translateX(-50%); }
    .wind-compass .E { right: 5px; top: 50%; transform: translateY(-50%); }
    .wind-compass .W { left: 5px; top: 50%; transform: translateY(-50%); }

    .wind-arrow {
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 36px solid;
      position: absolute;
      left: 50%;
      top: 50%;
      transform-origin: center center;
      transform: translate(-50%, -50%);
    }

    /* Raw METAR */
    .raw-text {
      margin-top: 1rem;
      padding: 0.7rem;
      background: #f5f7fa;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
      text-align: left;
      border-left: 4px solid #1a73e8;
    }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ‡¨ðŸ‡¦ Canada METAR Viewer</h1>
    <p>Select an airport to explore live aviation conditions</p>
    <a href="map.html" class="map-btn"><i class="fas fa-map"></i> View as Map</a>
  </header>

  <main>
    <div class="selector">
      <select id="airportSelect">
        <option disabled selected>Loading airports...</option>
      </select>
    </div>

    <div class="last-updated" id="lastUpdated"></div>
    <div id="airportCard"></div>
  </main>

  <script>
    function toLocalTime(utcString) {
      if (!utcString) return "";
      const date = new Date(utcString + "Z");
      return date.toLocaleString('en-CA', {
        timeZone: 'America/Toronto',
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
      });
    }

    function windColor(speed) {
      if (speed <= 10) return "#2ecc71";
      if (speed <= 20) return "#f1c40f";
      if (speed <= 30) return "#e67e22";
      return "#e74c3c";
    }

    const stations = {
      CYER:"Fort Severn", CYAT:"Attawapiskat", CYMO:"Moosonee", CYPL:"Pickle Lake",
      CYQT:"Thunder Bay", CYAM:"Sault Ste. Marie", CYTS:"Timmins", CYSB:"Sudbury",
      CYYB:"North Bay", CYOW:"Ottawa", CYGK:"Kingston", CYQG:"Windsor",
      CYVV:"Wiarton/Owen Sound", CYYZ:"Toronto Pearson", CYQA:"Muskoka",
      CYVR:"Vancouver", CYYJ:"Victoria", CYLW:"Kelowna", CYXS:"Prince George", CYXT:"Terrace", CYQQ:"Comox",
      CYYC:"Calgary", CYEG:"Edmonton", CYMM:"Fort McMurray", CYQF:"Red Deer",
      CYXE:"Saskatoon", CYQR:"Regina", CYWG:"Winnipeg", CYBR:"Brandon",
      CYUL:"Montreal-Trudeau", CYHU:"Montreal St-Hubert", CYQB:"Quebec City", CYVO:"Val-dâ€™Or",
      CYUY:"Rouyn-Noranda", CYZV:"Sept-ÃŽles", CYBC:"Baie-Comeau", CYRJ:"Roberval",
      CYHZ:"Halifax", CYYG:"Charlottetown", CYQM:"Moncton", CYFC:"Fredericton",
      CYYT:"St. John's", CYQY:"Sydney",
      CYXY:"Whitehorse", CYZF:"Yellowknife", CYFB:"Iqaluit", CYRT:"Rankin Inlet",
      CYBK:"Baker Lake", CYRB:"Resolute Bay", CYCO:"Kugluktuk"
    };

    let latestByAirport = {};
    let globalLatest = null;

    Papa.parse("all_metars.csv", {
      download: true,
      header: true,
      complete: function(results) {
        const rows = results.data.filter(r => r.icao && r.observed_utc && stations[r.icao]);

        rows.forEach(r => {
          const t = new Date(r.observed_utc);
          if (!latestByAirport[r.icao] || t > new Date(latestByAirport[r.icao].observed_utc)) {
            latestByAirport[r.icao] = r;
          }
          if (!globalLatest || t > new Date(globalLatest)) {
            globalLatest = r.observed_utc;
          }
        });

        if (globalLatest) {
          document.getElementById("lastUpdated").textContent =
            "Data as of " + toLocalTime(globalLatest);
        }

        const sel = document.getElementById("airportSelect");
        sel.innerHTML = '<option disabled selected>Select an airport...</option>';
        for (const [icao, name] of Object.entries(stations)) {
          const opt = document.createElement("option");
          opt.value = icao;
          opt.textContent = `${icao} â€” ${name}`;
          sel.appendChild(opt);
        }

        sel.addEventListener("change", () => {
          renderCard(sel.value);
        });
      }
    });

    function renderCard(icao) {
      const r = latestByAirport[icao];
      if (!r) return;

      const speed = parseInt(r.wind_kts) || 0;
      const deg = parseInt(r.wind_dir_deg) || 0;

      document.getElementById("airportCard").innerHTML = `
        <div class="card">
          <div class="icao">${icao}</div>
          <div class="airport-name">${stations[icao]}</div>
          <div class="category cat-${r.flight_category}">${r.flight_category}</div>
          <div class="obs-time">${toLocalTime(r.observed_utc)}</div>
          <div class="temp">${r.temp_c}Â°C</div>
          <div class="dew">Dewpoint: ${r.dewpoint_c}Â°C</div>
          <div class="humidity">Humidity: ${r.rh_percent}%</div>
          <div class="altimeter">Altimeter: ${r.altimeter_hg} inHg</div>
          <div class="wind">
            <div class="wind-compass">
              <div class="label N">N</div>
              <div class="label S">S</div>
              <div class="label E">E</div>
              <div class="label W">W</div>
              <div class="wind-arrow"
                   style="transform: translate(-50%, -50%) rotate(${deg}deg);
                          border-top-color:${windColor(speed)}"></div>
            </div>
            ${deg}Â° @ ${speed} kts
          </div>
          <div class="raw-text">${r.raw_text || ""}</div>
        </div>
      `;
    }
  </script>
</body>
</html>
