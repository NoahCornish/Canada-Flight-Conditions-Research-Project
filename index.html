<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ontario METAR Flight Conditions</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body, html { margin:0; padding:0; font-family:'Inter', sans-serif; background:#f4f6f8; color:#2c3e50; }
    header { background: linear-gradient(135deg,#3498db,#2ecc71); padding:1rem; text-align:center; color:white; position:sticky; top:0; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
    header h1 { margin:0; font-size:1.6rem; }
    header p { margin:0.25rem 0 0; font-size:0.9rem; opacity:0.9; }
    main { max-width:1200px; margin:auto; padding:1.5rem; }
    h2 { color:#34495e; font-size:1.3rem; border-bottom:2px solid #e0e0e0; padding-bottom:0.25rem; margin-top:1.5rem; }
    .legend, .wind-legend { display:flex; justify-content:center; gap:1rem; flex-wrap:wrap; margin:0.5rem 0 1rem; font-size:0.9rem; }
    .legend span, .wind-legend span { display:flex; align-items:center; gap:0.3rem; }
    .dot { width:12px; height:12px; border-radius:50%; display:inline-block; }
    .dot-vfr { background:#2ecc71; }
    .dot-mvfr { background:#3498db; }
    .dot-ifr { background:#e74c3c; }
    .dot-lifr { background:#8e44ad; }
    .dot-calm { background:#2ecc71; }
    .dot-moderate { background:#f1c40f; }
    .dot-strong { background:#e67e22; }
    .dot-severe { background:#e74c3c; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:1rem; margin-top:1rem; }
    .card { background:white; border-radius:12px; padding:1rem; box-shadow:0 3px 8px rgba(0,0,0,0.1); cursor:pointer; transition:transform .15s; text-align:center; }
    .card:hover { transform:translateY(-3px); }
    .icao { font-size:1.3rem; font-weight:700; margin-bottom:4px; }
    .category { font-size:0.85rem; padding:3px 8px; border-radius:6px; font-weight:bold; color:white; display:inline-block; margin-bottom:6px; }
    .cat-VFR { background:#2ecc71; }
    .cat-MVFR { background:#3498db; }
    .cat-IFR { background:#e74c3c; }
    .cat-LIFR { background:#8e44ad; }
    .temp { font-size:1.1rem; font-weight:500; }
    .humidity { font-size:0.85rem; color:#666; }
    .obs-time { font-size:0.75rem; color:#777; margin-top:6px; }
    .wind { font-size:0.8rem; margin-top:6px; }
    .wind-compass { position:relative; width:70px; height:70px; margin:0 auto 6px; border:2px solid #bbb; border-radius:50%; font-size:0.65rem; color:#555; }
    .wind-compass .label { position:absolute; font-weight:bold; }
    .wind-compass .N { top:2px; left:50%; transform:translateX(-50%); }
    .wind-compass .S { bottom:2px; left:50%; transform:translateX(-50%); }
    .wind-compass .E { right:2px; top:50%; transform:translateY(-50%); }
    .wind-compass .W { left:2px; top:50%; transform:translateY(-50%); }
    .wind-arrow { width:0; height:0; border-left:8px solid transparent; border-right:8px solid transparent; border-top:28px solid; position:absolute; left:50%; top:50%; transform-origin:center center; transform:translate(-50%,-50%); }
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
    .modal-content { background:white; border-radius:10px; padding:1.5rem; width:95%; max-width:600px; box-shadow:0 4px 10px rgba(0,0,0,0.3); position:relative; font-size:0.95rem; }
    .modal h3 { margin-top:0; font-size:1.3rem; border-bottom:2px solid #eee; padding-bottom:0.4rem; }
    .close-btn { position:absolute; top:12px; right:18px; font-size:1.4rem; font-weight:bold; color:#e74c3c; cursor:pointer; }
    .close-btn:hover { color:#000; }
    .raw-section { margin-top:1rem; font-size:0.85rem; background:#f8f9fa; padding:0.8rem; border-radius:6px; font-family:monospace; white-space:pre-wrap; }
  </style>
</head>
<body>
  <header>
    <h1>üå§Ô∏è Ontario METAR Flight Conditions</h1>
    <p>Using cleaned METAR data from 15 Ontario airports</p>
  </header>
  <main>
    <h2>üìä Live Conditions</h2>
    <div id="lastUpdated" class="obs-time"></div>
    <div class="legend">
      <span><span class="dot dot-vfr"></span> VFR</span>
      <span><span class="dot dot-mvfr"></span> MVFR</span>
      <span><span class="dot dot-ifr"></span> IFR</span>
      <span><span class="dot dot-lifr"></span> LIFR</span>
    </div>
    <div class="legend wind-legend">
      <span><span class="dot dot-calm"></span> 0‚Äì10 kts</span>
      <span><span class="dot dot-moderate"></span> 11‚Äì20 kts</span>
      <span><span class="dot dot-strong"></span> 21‚Äì30 kts</span>
      <span><span class="dot dot-severe"></span> 31+ kts</span>
    </div>
    <div id="airportGrid" class="grid"></div>
  </main>
  <div id="metarModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">‚úñ</span>
      <h3 id="modalTitle"></h3>
      <div id="modalDetails"></div>
      <div id="modalRaw" class="raw-section"></div>
    </div>
  </div>
  <script>
    function toEDT(utcString) {
      if(!utcString) return '';
      const d = new Date(utcString + 'Z');
      d.setHours(d.getHours() - 4);
      return d.toISOString().replace('T',' ').substring(0,16);
    }
    function windColor(speed) {
      if(speed<=10) return '#2ecc71';
      if(speed<=20) return '#f1c40f';
      if(speed<=30) return '#e67e22';
      return '#e74c3c';
    }
    function showModal(title, r) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalDetails').innerHTML = `
        <div><strong>Observed:</strong> ${toEDT(r.observed_utc)}</div>
        <div><strong>Flight Rules:</strong> ${r.flight_category}</div>
        <div><strong>Temp:</strong> ${r.temp_c} ¬∞C &nbsp;&nbsp; <strong>Dew:</strong> ${r.dewpoint_c} ¬∞C</div>
        <div><strong>Humidity:</strong> ${r.rh_percent}%</div>
        <div><strong>Wind:</strong> ${r.wind_dir_deg}¬∞ @ ${r.wind_kts} kts</div>
        <div><strong>Altimeter:</strong> ${r.altimeter_hg} inHg</div>
        <div><strong>Conditions:</strong> ${r.conditions||'‚Äì'}</div>`;
      document.getElementById('modalRaw').textContent = r.raw_text || 'No raw METAR available';
      document.getElementById('metarModal').style.display = 'flex';
    }
    function closeModal() {
      document.getElementById('metarModal').style.display = 'none';
    }
    Papa.parse('clean_metars.csv', {
      download: true, header: true,
      complete(results) {
        const rows = results.data;
        const latestByICAO = {};
        let latestTime = null;
        rows.forEach(r => {
          if(!r.icao) return;
          const t = new Date(r.observed_utc);
          if(!latestByICAO[r.icao] || t > new Date(latestByICAO[r.icao].observed_utc)) {
            latestByICAO[r.icao] = r;
          }
          if(r.observed_utc && (!latestTime || t > new Date(latestTime))) {
            latestTime = r.observed_utc;
          }
        });
        if(latestTime) {
          document.getElementById('lastUpdated').textContent = 'Last Updated: ' + toEDT(latestTime) + ' EDT';
        }
        const grid = document.getElementById('airportGrid');
        Object.values(latestByICAO).forEach(r => {
          const speed = parseInt(r.wind_kts) || 0;
          const deg = parseInt(r.wind_dir_deg) || 0;
          const div = document.createElement('div');
          div.className = 'card';
          div.innerHTML = `
            <div class="icao">${r.icao}</div>
            <div class="category cat-${r.flight_category}">${r.flight_category}</div>
            <div class="obs-time">${toEDT(r.observed_utc)}</div>
            <div class="temp">${r.temp_c} ¬∞C</div>
            <div class="humidity">üíß ${r.rh_percent}%</div>
            <div class="wind">
              <div class="wind-compass">
                <div class="label N">N</div><div class="label S">S</div>
                <div class="label E">E</div><div class="label W">W</div>
                <div class="wind-arrow"
                     style="transform:translate(-50%,-50%) rotate(${deg}deg);
                            border-top-color:${windColor(speed)};">
                </div>
              </div>
              ${deg}¬∞ @ ${speed} kts
            </div>`;
          div.addEventListener('click', () => showModal(`${r.icao}`, r));
          grid.appendChild(div);
        });
      }
    });
  </script>
</body>
</html>
