<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Canada METAR Viewer</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      margin: 0;
      background: #f7f9fb;
      color: #2c3e50;
    }

    header {
      background: linear-gradient(135deg, #3498db, #2ecc71);
      color: white;
      padding: 1.2rem;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    header h1 {
      margin: 0;
      font-size: 1.8rem;
    }
    header p {
      margin: 0.3rem 0 0;
      font-size: 0.95rem;
      opacity: 0.9;
    }

    main {
      max-width: 1200px;
      margin: auto;
      padding: 1.5rem;
    }

    /* Dropdown selector */
    .selector {
      text-align: center;
      margin: 1.5rem 0;
    }
    select {
      padding: 0.6rem 1rem;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-family: inherit;
      width: 80%;
      max-width: 500px;
    }

    .last-updated {
      text-align: center;
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 1rem;
    }

    /* Card style */
    .card {
      background: white;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-top: 1rem;
      text-align: center;
      transition: transform 0.15s ease-in-out;
    }
    .card:hover {
      transform: translateY(-4px);
    }

    .icao {
      font-size: 1.4rem;
      font-weight: 600;
      margin-bottom: 0.2rem;
    }
    .airport-name {
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 0.6rem;
    }
    .obs-time {
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 0.6rem;
    }
    .temp {
      font-size: 1.3rem;
      margin-bottom: 0.3rem;
      font-weight: 500;
    }
    .dew {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 0.3rem;
    }
    .humidity, .altimeter {
      font-size: 0.85rem;
      margin: 2px 0;
      color: #444;
    }

    /* Category badge */
    .category {
      font-size: 0.85rem;
      font-weight: bold;
      padding: 3px 8px;
      border-radius: 6px;
      margin: 0.4rem auto;
      display: inline-block;
      color: white;
    }
    .cat-VFR {
      background: #2ecc71;
    }
    .cat-MVFR {
      background: #3498db;
    }
    .cat-IFR {
      background: #e74c3c;
    }
    .cat-LIFR {
      background: #8e44ad;
    }

    /* Wind compass */
    .wind {
      font-size: 0.9rem;
      margin-top: 8px;
    }
    .wind-compass {
      position: relative;
      width: 80px;
      height: 80px;
      margin: 0.5rem auto;
      border: 2px solid #bbb;
      border-radius: 50%;
      font-size: 0.7rem;
      color: #555;
    }
    .wind-compass .label {
      position: absolute;
      font-weight: bold;
    }
    .wind-compass .N {
      top: 2px;
      left: 50%;
      transform: translateX(-50%);
    }
    .wind-compass .S {
      bottom: 2px;
      left: 50%;
      transform: translateX(-50%);
    }
    .wind-compass .E {
      right: 2px;
      top: 50%;
      transform: translateY(-50%);
    }
    .wind-compass .W {
      left: 2px;
      top: 50%;
      transform: translateY(-50%);
    }

    .wind-arrow {
      width: 0;
      height: 0;
      border-left: 9px solid transparent;
      border-right: 9px solid transparent;
      border-top: 32px solid;
      position: absolute;
      left: 50%;
      top: 50%;
      transform-origin: center center;
      transform: translate(-50%, -50%);
    }

    /* Raw METAR text */
    .raw-text {
      margin-top: 0.75rem;
      padding: 0.5rem;
      background: #f0f0f0;
      border-radius: 6px;
      font-family: monospace;
      font-size: 0.8rem;
      white-space: pre-wrap;
      text-align: left;
    }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ‡¨ðŸ‡¦ Canada METAR Viewer</h1>
    <p>Select an airport to view the latest METAR</p>
  </header>

  <main>
    <div class="selector">
      <select id="airportSelect">
        <option disabled selected>Loading airports...</option>
      </select>
    </div>

    <div class="last-updated" id="lastUpdated"></div>
    <div id="airportCard"></div>
  </main>

  <script>
    function toLocalTime(utcString) {
      if (!utcString) return "";
      const date = new Date(utcString + "Z");
      return date.toLocaleString('en-CA', {
        timeZone: 'America/Toronto',
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
      });
    }

    function windColor(speed) {
      if (speed <= 10) return "#2ecc71"; // green
      if (speed <= 20) return "#f1c40f"; // yellow
      if (speed <= 30) return "#e67e22"; // orange
      return "#e74c3c"; // red
    }

    // Airport ICAOs and Names (50 total)
    const stations = {
      // Ontario (15 fixed)
      CYER:"Fort Severn", CYAT:"Attawapiskat", CYMO:"Moosonee", CYPL:"Pickle Lake",
      CYQT:"Thunder Bay", CYAM:"Sault Ste. Marie", CYTS:"Timmins", CYSB:"Sudbury",
      CYYB:"North Bay", CYOW:"Ottawa", CYGK:"Kingston", CYQG:"Windsor",
      CYVV:"Wiarton/Owen Sound", CYYZ:"Toronto Pearson", CYQA:"Muskoka",
      // BC
      CYVR:"Vancouver", CYYJ:"Victoria", CYLW:"Kelowna", CYXS:"Prince George", CYXT:"Terrace", CYQQ:"Comox",
      // Alberta
      CYYC:"Calgary", CYEG:"Edmonton", CYMM:"Fort McMurray", CYQF:"Red Deer",
      // Sask/MB
      CYXE:"Saskatoon", CYQR:"Regina", CYWG:"Winnipeg", CYBR:"Brandon",
      // Quebec
      CYUL:"Montreal-Trudeau", CYHU:"Montreal St-Hubert", CYQB:"Quebec City", CYVO:"Val-dâ€™Or",
      CYUY:"Rouyn-Noranda", CYZV:"Sept-ÃŽles", CYBC:"Baie-Comeau", CYRJ:"Roberval",
      // Atlantic
      CYHZ:"Halifax", CYYG:"Charlottetown", CYQM:"Moncton", CYFC:"Fredericton",
      CYYT:"St. John's", CYQY:"Sydney",
      // North
      CYXY:"Whitehorse", CYZF:"Yellowknife", CYFB:"Iqaluit", CYRT:"Rankin Inlet",
      CYBK:"Baker Lake", CYRB:"Resolute Bay", CYCO:"Kugluktuk"
    };

    let latestByAirport = {};
    let globalLatest = null;

    Papa.parse("all_metars.csv", {
      download: true,
      header: true,
      complete: function(results) {
        const rows = results.data.filter(r => r.icao && r.observed_utc && stations[r.icao]);

        // Find latest METAR for each airport
        rows.forEach(r => {
          const t = new Date(r.observed_utc);
          if (!latestByAirport[r.icao] || t > new Date(latestByAirport[r.icao].observed_utc)) {
            latestByAirport[r.icao] = r;
          }
          if (!globalLatest || t > new Date(globalLatest)) {
            globalLatest = r.observed_utc;
          }
        });

        // Last updated text
        if (globalLatest) {
          document.getElementById("lastUpdated").textContent =
            "Data as of " + toLocalTime(globalLatest);
        }

        // Populate dropdown
        const sel = document.getElementById("airportSelect");
        sel.innerHTML = '<option disabled selected>Select an airport...</option>';
        for (const [icao, name] of Object.entries(stations)) {
          const opt = document.createElement("option");
          opt.value = icao;
          opt.textContent = `${icao} â€” ${name}`;
          sel.appendChild(opt);
        }

        // Show card when selected
        sel.addEventListener("change", () => {
          renderCard(sel.value);
        });
      }
    });

    function renderCard(icao) {
      const r = latestByAirport[icao];
      if (!r) return;

      const speed = parseInt(r.wind_kts) || 0;
      const deg = parseInt(r.wind_dir_deg) || 0;

      document.getElementById("airportCard").innerHTML = `
        <div class="card">
          <div class="icao">${icao}</div>
          <div class="airport-name">${stations[icao]}</div>
          <div class="category cat-${r.flight_category}">${r.flight_category}</div>
          <div class="obs-time">${toLocalTime(r.observed_utc)}</div>
          <div class="temp">${r.temp_c}Â°C</div>
          <div class="dew">Dewpoint: ${r.dewpoint_c}Â°C</div>
          <div class="humidity">Humidity: ${r.rh_percent}%</div>
          <div class="altimeter">Altimeter: ${r.altimeter_hg} inHg</div>
          <div class="wind">
            <div class="wind-compass">
              <div class="label N">N</div>
              <div class="label S">S</div>
              <div class="label E">E</div>
              <div class="label W">W</div>
              <div class="wind-arrow"
                   style="transform: translate(-50%, -50%) rotate(${deg}deg);
                          border-top-color:${windColor(speed)}"></div>
            </div>
            ${deg}Â° @ ${speed} kts
          </div>
          <div class="raw-text">${r.raw_text || ""}</div>
        </div>
      `;
    }
  </script>
</body>
</html>
