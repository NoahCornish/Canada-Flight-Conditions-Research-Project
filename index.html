<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ontario METAR Flight Conditions</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body { margin:0; padding:0; font-family:'Inter',sans-serif; background:#f4f6f8; color:#2c3e50; }
    header { background:linear-gradient(135deg,#3498db,#2ecc71); color:white; padding:1rem; text-align:center; }
    h1 { margin:0; font-size:1.6rem; }
    p { margin:0.25rem 0 0; font-size:0.9rem; opacity:0.9; }
    main { max-width:800px; margin:auto; padding:1.5rem; }
    .grid { display:grid; grid-template-columns:1fr; gap:1rem; margin-top:1rem; }
    .card { background:white; border-radius:12px; padding:1rem; box-shadow:0 3px 8px rgba(0,0,0,0.1); text-align:center; cursor:pointer; }
    .icao { font-size:1.4rem; font-weight:700; margin-bottom:6px; }
    .category { padding:3px 8px; border-radius:6px; font-weight:bold; color:white; margin-bottom:6px; display:inline-block; }
    .cat-VFR { background:#2ecc71; } .cat-MVFR { background:#3498db; } .cat-IFR { background:#e74c3c; } .cat-LIFR { background:#8e44ad; }
    .wind-compass { position:relative; width:70px; height:70px; margin:10px auto; border:2px solid #bbb; border-radius:50%; }
    .wind-compass .label { position:absolute; font-size:0.7rem; font-weight:bold; }
    .N { top:2px; left:50%; transform:translateX(-50%); }
    .S { bottom:2px; left:50%; transform:translateX(-50%); }
    .E { right:2px; top:50%; transform:translateY(-50%); }
    .W { left:2px; top:50%; transform:translateY(-50%); }
    .wind-arrow { width:0; height:0; border-left:8px solid transparent; border-right:8px solid transparent;
                  border-top:28px solid; position:absolute; left:50%; top:50%;
                  transform-origin:center center; transform:translate(-50%,-50%); }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6);
             justify-content:center; align-items:center; }
    .modal-content { background:white; border-radius:10px; padding:1.5rem; max-width:600px; width:90%; position:relative; }
    .close-btn { position:absolute; top:10px; right:15px; font-size:1.4rem; font-weight:bold; color:#e74c3c; cursor:pointer; }
    .raw-section { margin-top:1rem; padding:0.8rem; background:#f8f9fa; border-radius:6px; font-family:monospace; font-size:0.85rem; white-space:pre-wrap; }
    .last-updated { text-align:center; font-size:0.9rem; color:#666; margin-top:1rem; }
  </style>
</head>
<body>
  <header>
    <h1>üå§Ô∏è Ontario METAR Flight Conditions</h1>
    <p>Showing the most recent cleaned METAR</p>
  </header>
  <main>
    <div class="grid" id="airportGrid"></div>
    <div id="lastUpdated" class="last-updated"></div>
  </main>

  <!-- Modal -->
  <div id="metarModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">‚úñ</span>
      <h3 id="modalTitle"></h3>
      <div id="modalDetails"></div>
      <div id="modalRaw" class="raw-section"></div>
    </div>
  </div>

  <script>
    function toEDT(utcString) {
      if(!utcString) return '';
      const d = new Date(utcString + 'Z');
      d.setHours(d.getHours() - 4);
      return d.toISOString().replace('T',' ').substring(0,16);
    }
    function windColor(speed) {
      if(speed<=10) return '#2ecc71';
      if(speed<=20) return '#f1c40f';
      if(speed<=30) return '#e67e22';
      return '#e74c3c';
    }
    function showModal(r) {
      document.getElementById('modalTitle').textContent = r.icao + " ‚Äì " + (r.flight_category||'Unknown');
      document.getElementById('modalDetails').innerHTML = `
        <div><strong>Observed:</strong> ${toEDT(r.observed_utc)}</div>
        <div><strong>Temp:</strong> ${r.temp_c}¬∞C (Dew ${r.dewpoint_c}¬∞C)</div>
        <div><strong>Humidity:</strong> ${r.rh_percent}%</div>
        <div><strong>Wind:</strong> ${r.wind_dir_deg}¬∞ @ ${r.wind_kts} kts</div>
        <div><strong>Altimeter:</strong> ${r.altimeter_hg} inHg</div>
        <div><strong>Conditions:</strong> ${r.conditions||'‚Äì'}</div>`;
      document.getElementById('modalRaw').textContent = r.raw_text || 'No raw METAR available';
      document.getElementById('metarModal').style.display = 'flex';
    }
    function closeModal(){ document.getElementById('metarModal').style.display='none'; }

    Papa.parse("clean_metars.csv", {
      download:true, header:true,
      complete(results) {
        const rows = results.data.filter(r => r.observed_utc);
        if(rows.length === 0) return;

        // Find the newest overall METAR
        let latest = rows.reduce((a,b) => new Date(a.observed_utc) > new Date(b.observed_utc) ? a : b);

        const speed = parseInt(latest.wind_kts)||0;
        const deg = parseInt(latest.wind_dir_deg)||0;

        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="icao">${latest.icao}</div>
          <div class="category cat-${latest.flight_category}">${latest.flight_category}</div>
          <div class="obs-time">${toEDT(latest.observed_utc)}</div>
          <div class="temp">${latest.temp_c}¬∞C</div>
          <div class="humidity">üíß ${latest.rh_percent}%</div>
          <div class="wind">
            <div class="wind-compass">
              <div class="label N">N</div><div class="label S">S</div>
              <div class="label E">E</div><div class="label W">W</div>
              <div class="wind-arrow" 
                   style="transform:translate(-50%,-50%) rotate(${deg}deg);
                          border-top-color:${windColor(speed)};">
              </div>
            </div>
            ${deg}¬∞ @ ${speed} kts
          </div>`;
        div.addEventListener("click", () => showModal(latest));
        document.getElementById("airportGrid").appendChild(div);

        document.getElementById("lastUpdated").textContent = "Last Updated: " + toEDT(latest.observed_utc) + " EDT";
      }
    });
  </script>
</body>
</html>
